services:
  postgres:
    image: postgres:17-alpine
    container_name: antihub-postgres
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-antihub}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-please-change-me}
      POSTGRES_DB: ${POSTGRES_DB:-antihub}
    volumes:
      - antihub_pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 5s
      timeout: 3s
      retries: 20
    networks:
      - antihub-network
    restart: unless-stopped

  postgres-init:
    image: postgres:17-alpine
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      PGHOST: postgres
      PGUSER: ${POSTGRES_USER:-antihub}
      PGPASSWORD: ${POSTGRES_PASSWORD:-please-change-me}
    command: >
      sh -c "
        psql -tc \"SELECT 1 FROM pg_roles WHERE rolname = 'antigravity'\" | grep -q 1 || psql -c \"CREATE ROLE antigravity WITH LOGIN PASSWORD '${POSTGRES_PASSWORD:-please-change-me}'\";
        psql -tc \"SELECT 1 FROM pg_database WHERE datname = 'antigravity'\" | grep -q 1 || psql -c \"CREATE DATABASE antigravity OWNER antigravity\";
        psql -d antigravity -c \"GRANT ALL PRIVILEGES ON DATABASE antigravity TO antigravity\"
      "
    networks:
      - antihub-network
    restart: "no"

  web:
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-web:${IMAGE_TAG:-latest}
    container_name: antihub-web
    environment:
      NODE_ENV: production
      # 可选：覆盖 web 容器内部访问 backend 的地址（容器内通常用 http://antihub-backend:8000）
      INTERNAL_API_BASE_URL: ${INTERNAL_API_BASE_URL:-http://backend:8000}
      BACKEND_INTERNAL_URL: ${BACKEND_INTERNAL_URL:-http://backend:8000}
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - backend
    ports:
      - "${WEB_PORT:-3000}:3000"
    networks:
      - antihub-network
    restart: unless-stopped

  backend:
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-backend:${IMAGE_TAG:-latest}
    container_name: antihub-backend
    environment:
      APP_ENV: production
      LOG_LEVEL: ${LOG_LEVEL:-INFO}

      # PostgreSQL：默认使用 compose 自带 postgres；如你有现成的 PG，可在 .env 里覆盖
      DATABASE_URL: ${DATABASE_URL:-postgresql+asyncpg://${POSTGRES_USER:-antihub}:${POSTGRES_PASSWORD:-please-change-me}@postgres:5432/${POSTGRES_DB:-antihub}}

      # Redis：默认使用 compose 自带 redis；如你有现成的 Redis，可在 .env 里覆盖
      REDIS_URL: ${REDIS_URL:-redis://redis:6379/0}

      # 内部互联（已预置，不需要你再配“互相链接”的环境变量）
      PLUGIN_API_BASE_URL: http://plugin:8045
      PLUGIN_API_ADMIN_KEY: ${PLUGIN_ADMIN_API_KEY}
      PLUGIN_API_ENCRYPTION_KEY: ${PLUGIN_API_ENCRYPTION_KEY}

      # 需要你自己配置的密钥/回调（外部可见）
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: HS256
      JWT_EXPIRE_HOURS: ${JWT_EXPIRE_HOURS:-24}
      REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-7}

      # 管理员账号配置（首次启动时自动创建）
      ADMIN_USERNAME: ${ADMIN_USERNAME:-}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-}

    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
      plugin:
        condition: service_started
    networks:
      - antihub-network
    restart: unless-stopped

  plugin:
    image: ghcr.io/${IMAGE_OWNER:-zhongruan0522}/antihub-plugin:${IMAGE_TAG:-latest}
    container_name: antihub-plugin
    environment:
      NODE_ENV: production
      PORT: 8045

      # PostgreSQL：默认使用 compose 自带 postgres；如你有现成的 PG，可在 .env 里覆盖
      DB_HOST: ${PLUGIN_DB_HOST:-postgres}
      DB_PORT: ${PLUGIN_DB_PORT:-5432}
      DB_NAME: ${PLUGIN_DB_NAME:-antigravity}
      DB_USER: ${PLUGIN_DB_USER:-antigravity}
      DB_PASSWORD: ${PLUGIN_DB_PASSWORD:-${POSTGRES_PASSWORD:-please-change-me}}

      # Redis：默认使用 compose 自带 redis；如你有现成的 Redis，可在 .env 里覆盖
      REDIS_HOST: ${PLUGIN_REDIS_HOST:-redis}
      REDIS_PORT: ${PLUGIN_REDIS_PORT:-6379}
      REDIS_PASSWORD: ${PLUGIN_REDIS_PASSWORD:-}

      # 需要你自己配置的密钥/回调（外部可见）
      ADMIN_API_KEY: ${PLUGIN_ADMIN_API_KEY}
      OAUTH_CALLBACK_URL: ${PLUGIN_OAUTH_CALLBACK_URL:-}

    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      postgres:
        condition: service_healthy
      postgres-init:
        condition: service_completed_successfully
      redis:
        condition: service_started
    networks:
      - antihub-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: antihub-redis
    command: redis-server --appendonly yes
    volumes:
      - antihub_redis_data:/data
    networks:
      - antihub-network
    restart: unless-stopped

volumes:
  antihub_pg_data:
  antihub_redis_data:

networks:
  antihub-network:
    driver: bridge
